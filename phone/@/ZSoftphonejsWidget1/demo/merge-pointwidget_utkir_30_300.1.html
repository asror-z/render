<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>btn</title>


    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
    <!-- Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
    <!-- Bootstrap core CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet">
    <!-- Material Design Bootstrap -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.16.0/css/mdb.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../../render/siplibs/All/css/style1.css"/>
</head>


<body>
<div class="wrapper">
    <div class="container-fluid no_pad">
        <button id="res_btn" class="res_btn btn btn-success"><i class="fas fa-phone-volume"></i></button>
        <div class="main_block">
            <div class="block_item or1">
                <div class="left_block">

                    <h1>
                        left_block
                    </h1>

                </div>
            </div>
            <div class="block_item or2">
                <div class="right_block">
                    <div class="opacity mt-3">
                        <div class="number text-center border w-10">
                            <div class="mb-2 mt-2 control_btn">
                                <button type="button" disabled class="btn btn-success btn-rounded btn-default"
                                        id="btnCall"
                                        value="Call"
                                        onclick="call();">
                                    <i class="fas success-ic fa-phone"></i></button>
                                <button type="button" disabled class="btn btn-success btn-rounded btn-default"
                                        value="HangUp"
                                        id="btnHangUp" onclick="hangup(); clr();">
                                    <i class="fas red-ic  fa-phone-slash"></i></button>
                            </div>
                            <div class="ml-4 mr-4">
                                <div id="txtRegStatus" style="height: 35px"></div>
                                <div id="txtCallStatus" class="" style="height: 25px"></div>
                                <div id="txtState" style="height: 35px"></div>
                                <div class=" md-form input-with-post-icon mt-lg-1">
                                    <i class=" fas white-ic fa-user input-prefix text-center "></i>
                                    <input type="text" id="phone_popup_number"
                                           class="form-control text-white text-center">
                                    <label for="phone_popup_number"></label>
                                </div>
                            </div>
                            <div class=" buton-goup mb-lg-4 mb-3">
                                <a type="button" class="btn-floating btn-lg btn-default" value="1"
                                   onclick="dis('1')">1</a>
                                <a type="button" class="btn-floating btn-lg btn-default" value="2"
                                   onclick="dis('2')">2</a>
                                <a type="button" class="btn-floating btn-lg btn-default" value="3"
                                   onclick="dis('3')">3</a>
                                <br>
                                <a type="button" class="btn-floating btn-lg btn-default" value="4"
                                   onclick="dis('4')">4</a>
                                <a type="button" class="btn-floating btn-lg btn-default" value="5"
                                   onclick="dis('5')">5</a>
                                <a type="button" class="btn-floating btn-lg btn-default" value="6"
                                   onclick="dis('6')">6</a>
                                <br>
                                <a type="button" class="btn-floating btn-lg btn-default" value="7"
                                   onclick="dis('7')">7</a>
                                <a type="button" class="btn-floating btn-lg btn-default" value="8"
                                   onclick="dis('8')">8</a>
                                <a type="button" class="btn-floating btn-lg btn-default" value="9"
                                   onclick="dis('9')">9</a>
                                <br>
                                <a type="button" class="btn-floating btn-lg btn-default" value="+"
                                   onclick="dis('+')">+</a>
                                <a type="button" class="btn-floating btn-lg btn-default" value="0"
                                   onclick="dis('0')">0</a>
                                <a type="button" class="btn-floating btn-lg btn-secondary" value="c" onclick="clr()">
                                    <i class="fas red-ic fa-backspace"></i></a>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/umd/popper.min.js"></script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.16.0/js/mdb.min.js"></script>
<audio id="audio_remote" autoplay="autoplay"></audio>
<audio id="ringtone" loop src="sounds/ringtone.wav"></audio>
<audio id="ringbacktone" loop src="sounds/ringbacktone.wav"></audio>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.0/dist/jquery.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/sipml@2.1.4/SIPml-api.js"></script>

<script>
    //function for displaying values
    function dis(val) {
        document.getElementById("phone_popup_number").value += val
    }

    function clr() {
        document.getElementById("phone_popup_number").value = ""
    }
</script>
<script>
    var sipStack;
    var registerSession;
    var callSession = null;


    var state = "null";//null, unregistered, registered, calling, incoming, incall

    function createSipStack() {
        console.log("createSipStack 1");
        sipStack = new SIPml.Stack({
            realm: '94.158.52.244:7777',
            impi: '301',
            impu: 'sip:301@94.158.52.244:7777',
            password: '301',
            websocket_proxy_url: 'wss://zoft.uz:8089/ws',
                ice_servers: "[]",
                enable_rtcweb_breaker: false,
                events_listener: {events: '*', listener: onSipEventStack}, // optional: '*' means all events
                sip_headers: [ // optional
                    {name: 'User-Agent', value: 'IM-client/OMA1.0 sipML5-v1.0.0.0'},
                    {name: 'Organization', value: 'TODO'}
                ]
            }
        );
        console.log("createSipStack 2");
    }

    var readyCallback = function (e) {
        createSipStack();
        console.info('sipml5 is ready');
    };
    var errorCallback = function (e) {
        console.error('Failed to initialize the engine: ' + e.message);
    }


    window.onload = function () {
        register();
    };

    // sends SIP REGISTER request to login
    function register() {
        //from onload begin
        //init finalState
        state = "null";
        txtState.innerHTML = state;
        finalState("init");
        //init SIPML5
        SIPml.init(readyCallback, errorCallback);//createSipStack
        //from onload end

        console.log("register 1");
        sipStack.start(); //event 'started', register
        finalState("register");
        console.log("register 2");
    }

    // sends SIP REGISTER (expires=0) to logout
    function unregister() {
        console.log("unregister 1");
        if (sipStack) {
            sipStack.stop(); // shutdown all sessions
        }
        finalState("unregister");
        console.log("unregister 2");
    }

    function onSipEventStack(e) {
        console.log("onSipEventStack 1, type = " + e.type);
        switch (e.type) {
            case 'started': { //register
                registerSession = sipStack.newSession('register', {
                    events_listener: {events: '*', listener: onSipEventSession} // optional: '*' means all events
                });
                registerSession.register();
                break;
            }
            case 'i_new_call': // incoming audio/video call
            {
                if (callSession) {
                    // do not accept the incoming call if we're already 'in call'
                    e.newSession.hangup(); // comment this line for multi-line support
                } else {
                    callSession = e.newSession;
                    // start listening for events
                    callSession.setConfiguration({
                        audio_remote: document.getElementById('audio_remote'),
                        events_listener: {events: '*', listener: onSipEventSession} // optional: '*' means all events
                    });

                    var sRemoteNumber = (callSession.getRemoteFriendlyName() || 'unknown');
                    txtCallStatus.innerHTML = txtCallStatus.value = "Incoming call from " + sRemoteNumber;
                    console.log("call = " + txtCallStatus.value);

                    finalState("incoming");
                }
                break;
            }
            case 'stopping':
            case 'stopped':
            case 'failed_to_start':
            case 'failed_to_stop': {
                var bFailure = (e.type == 'failed_to_start') || (e.type == 'failed_to_stop');
                oSipStack = null;
                oSipSessionRegister = null;
                oSipSessionCall = null;

                finalState("unregister");

                txtCallStatus.innerHTML = txtCallStatus.value = "";
                console.log("call = " + txtCallStatus.value);
                txtRegStatus.innerHTML = txtRegStatus.value = bFailure ? "Disconnected: " + e.description + "" : "Disconnected";
                console.log("reg = " + txtRegStatus.value);
                break;
            }
            case 'starting':
            default:
                break;
        }
        console.log("onSipEventStack 2");
    }

    function onSipEventSession(e) {
        console.log("onSipEventSession 1");
        console.info('session event = ' + e.type);
        switch (e.type) {
            case 'connecting':
            case 'connected': {
                var bConnected = (e.type === 'connected');
                if (e.session === registerSession) {
                    txtRegStatus.innerHTML = txtRegStatus.value = e.description;
                    console.log("reg = " + txtRegStatus.value);
                } else if (e.session === callSession) {
                    if (bConnected) {
                        finalState("call_or_answer");
                    }
                    txtCallStatus.innerHTML = txtCallStatus.value = e.description;
                    console.log("call = " + txtCallStatus.value);
                }
                break;
            } // 'connecting' | 'connected'
            case 'terminating':
            case 'terminated': {
                if (e.session == registerSession) {
                    callSession = null;
                    registerSession = null;

                    txtRegStatus.innerHTML = txtRegStatus.value = e.description;
                    console.log("reg = " + txtRegStatus.value);
                } else if (e.session == callSession) {
                    txtCallStatus.innerHTML = txtCallStatus.value = e.description;
                    console.log("call = " + txtCallStatus.value);
                    callSession = null;
                }
                if (e.type === 'terminated') {
                    finalState("hangup");
                    txtCallStatus.innerHTML = txtCallStatus.value = e.description;
                    console.log("call = " + txtCallStatus.value);
                }
                break;
            } // 'terminating' | 'terminated'
            case 'i_ao_request': {
                if (e.session == callSession) {
                    var iSipResponseCode = e.getSipResponseCode();
                    if (iSipResponseCode == 180 || iSipResponseCode == 183) {
                        finalState('calling');
                        txtCallStatus.innerHTML = txtCallStatus.value = 'Remote ringing...';
                        console.log("call = " + txtCallStatus.value);
                    }
                }
                break;
            }
        }
        console.log("onSipEventSession 2");
    }

    function eventsListener(e) {
        console.info('session event = ' + e.type);
    }

    function call() {
        console.log("call 1" + " " + document.getElementById("phone_popup_number").value.toString());
        if (callSession === null) {
            console.log("new call");
            if (document.getElementById("phone_popup_number").value.toString() === "") {
                alert("введите номер");
                return;
            }
            callSession = sipStack.newSession('call-audio', {
                audio_remote: document.getElementById('audio_remote'),
                events_listener: {events: '*', listener: onSipEventSession} // optional: '*' means all events
            });
            callSession.call(document.getElementById("phone_popup_number").value.toString());
        } else {
            txtCallStatus.innerHTML = txtCallStatus.value = 'Connecting...';
            console.log("call = " + txtCallStatus.value);
            callSession.accept();
            finalState("incall");
        }
        console.log("call 2");
    }

    // terminates the call (SIP BYE or CANCEL)
    function hangup() {
        if (callSession) {
            txtCallStatus.innerHTML = txtCallStatus.value = 'Terminating the call...';
            console.log("call = " + txtCallStatus.value);
            callSession.hangup({events_listener: {events: '*', listener: onSipEventSession}});
        }
    }


    function finalState(action) {
        switch (state) {
            case "null": {
                if (action === "init") {
                    btnCall.value = 'Call';
                    btnHangUp.value = 'HangUp';
                    btnCall.disabled = true;
                    btnHangUp.disabled = true;
                    /* btnRegister.disabled = false;
                     btnUnRegister.disabled = true;*/
                    state = "unregistered";
                }
                break;
            }
            case "unregistered": {
                if (action === "register") {
                    btnCall.value = 'Call';
                    btnHangUp.value = 'HangUp';
                    btnCall.disabled = false;
                    btnHangUp.disabled = true;
                    state = "registered";
                    /* btnRegister.disabled = true;
                     btnUnRegister.disabled = false;*/
                }
                break;
            }
            case "registered": {
                if (action === "calling") {
                    btnCall.value = 'Call';
                    btnHangUp.value = 'HangUp';
                    btnCall.disabled = true;
                    btnHangUp.disabled = false;
                    state = "calling";
                    startRingbackTone();
                }
                if (action === "incoming") {
                    btnCall.value = 'Answer';
                    btnHangUp.value = 'Reject';
                    btnCall.disabled = false;
                    btnHangUp.disabled = false;
                    state = "incoming";
                    startRingTone();
                }
                break;
            }
            case "calling": {
                if (action === "call_or_answer") {
                    btnCall.value = 'Call';
                    btnHangUp.value = 'HangUp';
                    btnCall.disabled = true;
                    btnHangUp.disabled = false;
                    state = "incall";
                    stopRingbackTone();
                } else if (action === "hangup") {
                    btnCall.value = 'Call';
                    btnHangUp.value = 'HangUp';
                    btnCall.disabled = false;
                    btnHangUp.disabled = true;
                    state = "registered";
                    stopRingbackTone();
                }
                break;
            }
            case "incoming": {
                if (action === "call_or_answer") {
                    btnCall.value = 'Call';
                    btnHangUp.value = 'HangUp';
                    btnCall.disabled = true;
                    btnHangUp.disabled = false;
                    state = "incall";
                    stopRingTone();
                } else if (action === "hangup") {
                    btnCall.value = 'Call';
                    btnHangUp.value = 'HangUp';
                    btnCall.disabled = false;
                    btnHangUp.disabled = true;
                    state = "registered";
                    stopRingTone();
                }
                break;
            }
            case "incall": {
                if (action === "hangup") {
                    btnCall.value = 'Call';
                    btnHangUp.value = 'HangUp';
                    btnCall.disabled = false;
                    btnHangUp.disabled = true;
                    state = "registered";
                }
                break;
            }
        }
        if (action === "unregister") {
            btnCall.value = 'Call';
            btnHangUp.value = 'HangUp';
            btnCall.disabled = true;
            btnHangUp.disabled = true;
            /* btnRegister.disabled = false;
             btnUnRegister.disabled = true;*/
            state = "unregistered";
            stopRingTone();
            stopRingbackTone();
        }
        txtState.innerHTML = state;
        console.log("state = " + state);
    }

    // function startRingTone() {
    //     try {
    //         ringtone.play();
    //     } catch (e) {
    //     }
    // }

    // function stopRingTone() {
    //     try {
    //         ringtone.pause();
    //     } catch (e) {
    //     }
    // }

    // function startRingbackTone() {
    //     try {
    //         ringbacktone.play();
    //     } catch (e) {
    //     }
    // }

    // function stopRingbackTone() {
    //     try {
    //         ringbacktone.pause();
    //     } catch (e) {
    //     }
    // }

</script>
<script>
    $(document).ready(function () {

        $('#res_btn').click(function () {
            // $(this).preventDefault();
            $('.or2').toggleClass('res_active');
        });

        $('.out_phone').click(function () {
            $('.or2').removeClass('res_active');
        });


    });
</script>


</body>
</html>

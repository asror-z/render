/**
 * jQuery Menu Editor
 * @author David Ticona Saravia https://github.com/davicotico
 * @version 0.9.0
 * */
function MenuEditor(e,t){var s=$("#"+e),l={labelEdit:'<i class="glyphicon glyphicon-edit clickable"></i>',labelRemove:'<i class="glyphicon glyphicon-remove clickable"></i>',textConfirmDelete:"This item will be deleted. Are you sure?",iconPicker:{cols:5,footer:!1},listOptions:{hintCss:{border:"1px dashed #13981D"},opener:{as:"html",close:'<i class="fa fa-minus"></i>',open:'<i class="fa fa-plus"></i>',openerCss:{"margin-right":"10px"},openerClass:"btn btn-success btn-xs"},placeholderCss:{"background-color":"gray"}}};$.extend(!0,l,t);var n=null,i=!0,o=null,r=null,a=l.iconPicker,c=(t=l.listOptions,$("#"+e+"_icon").iconpicker(a));function d(){o[0].reset(),(c=c.iconpicker(a)).iconpicker("setIcon","empty"),r.attr("disabled",!0),n=null}function p(e){return $("<a>").addClass(e.classCss).addClass("clickable").attr("href","#").html(e.text)}function u(){var e=$("<div>").addClass("btn-group pull-right"),t=p({classCss:"btn btn-primary btn-xs btnEdit",text:l.labelEdit}),s=p({classCss:"btn btn-danger btn-xs btnRemove",text:l.labelRemove}),n=p({classCss:"btn btn-default btn-xs btnUp btnMove",text:'<i class="glyphicon glyphicon-chevron-up clickable"></i>'}),i=p({classCss:"btn btn-default btn-xs btnDown btnMove",text:'<i class="glyphicon glyphicon-chevron-down clickable"></i>'}),o=p({classCss:"btn btn-default btn-xs btnOut btnMove",text:'<i class="glyphicon glyphicon-save clickable"></i>'}),r=p({classCss:"btn btn-default btn-xs btnIn btnMove",text:'<i class="glyphicon glyphicon-export clickable"></i>'});return e.append(n).append(i).append(r).append(o).append(t).append(s),e}function f(e){$("<span>").addClass("sortableListsOpener "+t.opener.openerClass).css(t.opener.openerCss).on("mousedown",function(e){var s=$(this).closest("li");return s.hasClass("sortableListsClosed")?s.iconOpen(t):s.iconClose(t),!1}).prependTo(e.children("div").first()),e.hasClass("sortableListsOpen")?e.iconOpen(t):e.iconClose(t)}s.sortableLists(l.listOptions),c.on("change",function(e){var t=""!==e.iconClass?e.iconClass+" ":"";o.find("[name=icon]").val(t+e.icon)}),$(document).on("click",".btnRemove",function(t){if(t.preventDefault(),confirm(l.textConfirmDelete)){var n=$(this).closest("ul");$(this).closest("li").remove();var i=!1;void 0!==n.attr("id")&&(i=n.attr("id").toString()===e),n.children().length||i||(n.prev("div").children(".sortableListsOpener").first().remove(),n.remove()),MenuEditor.updateButtons(s)}}),$(document).on("click",".btnEdit",function(e){e.preventDefault(),function(e){var t=e.data();$.each(t,function(e,t){o.find("[name="+e+"]").val(t)}),o.find(".item-menu").first().focus(),t.hasOwnProperty("icon")&&c.iconpicker("setIcon",(s=t.icon,1===(l=s.split(" ")).length?l[0]:2===l.length?l[1]:"empty"));var s,l;r.removeAttr("disabled")}(n=$(this).closest("li"))}),s.on("click",".btnUp",function(e){e.preventDefault();var t=$(this).closest("li");t.prev("li").before(t),MenuEditor.updateButtons(s)}),s.on("click",".btnDown",function(e){e.preventDefault();var t=$(this).closest("li");t.next("li").after(t),MenuEditor.updateButtons(s)}),s.on("click",".btnOut",function(e){e.preventDefault();var t=$(this).closest("ul"),l=$(this).closest("li");l.closest("ul").closest("li").after(l),t.children().length<=0&&(t.prev("div").children(".sortableListsOpener").first().remove(),t.remove()),MenuEditor.updateButtons(s)}),s.on("click",".btnIn",function(e){e.preventDefault();var t=$(this).closest("li"),l=t.prev("li");if(l.length>0)if((n=l.children("ul")).length>0)n.append(t);else{var n=$("<ul>");l.append(n),n.append(t),l.addClass("sortableListsOpen"),f(l)}MenuEditor.updateButtons(s)}),this.setForm=function(e){o=e},this.getForm=function(){return o},this.setUpdateButton=function(e){(r=e).attr("disabled",!0),n=null},this.getUpdateButton=function(){return r},this.getCurrentItem=function(){return n},this.update=function(){var e=this.getCurrentItem();if(null!==e){var t=e.data("icon");o.find(".item-menu").each(function(){e.data($(this).attr("name"),$(this).val())}),e.children().children("i").removeClass(t).addClass(e.data("icon")),e.find("span.txt").first().text(e.data("text")),d()}},this.add=function(){var e={};o.find(".item-menu").each(function(){e[$(this).attr("name")]=$(this).val()});var t=u(),l=$("<span>").addClass("txt").text(e.text),n=$("<i>").addClass(e.icon),i=$("<div>").append(n).append("&nbsp;").append(l).append(t),r=$("<li>").data(e);r.addClass("list-group-item").append(i),s.append(r),MenuEditor.updateButtons(s),d()},this.getString=function(){var e=s.sortableListsToJson();return JSON.stringify(e)},this.setData=function(e){var t=Array.isArray(e)?e:function(e){try{var t=JSON.parse(e)}catch(e){return console.log("The string is not a json valid."),null}return t}(e);if(null!==t){s.empty();var n=function e(t,l){var n=void 0===l?0:l,i=0===n?s:$("<ul>");return $.each(t,function(t,s){var l=void 0!==s.children&&$.isArray(s.children),o={text:"",href:"",icon:"empty",target:"_self",title:""},r=$.extend({},s);l&&delete r.children,$.extend(o,r);var a=$("<li>").addClass("list-group-item");a.data(o);var c=$("<div>").css("margin-bottom","5px"),d=$("<i>").addClass(s.icon),p=$("<span>").addClass("txt").append(s.text),f=u();c.append(d).append("&nbsp;").append(p).append(f),a.append(c),l&&a.append(e(s.children,n+1)),i.append(a)}),i}(t);i?s.find("li").each(function(){var e=$(this);e.children("ul").length&&f(e)}):(n.sortableLists(l.listOptions),i=!0),MenuEditor.updateButtons(s)}}}!function(e){e.fn.sortableLists=function(t){var s=this,l=e("body").css("position","relative"),n={currElClass:"",placeholderClass:"",placeholderCss:{position:"relative",padding:0},hintClass:"",hintCss:{display:"none",position:"relative",padding:0},hintWrapperClass:"",hintWrapperCss:{},baseClass:"",baseCss:{position:"absolute",top:0-parseInt(l.css("margin-top")),left:0-parseInt(l.css("margin-left")),margin:0,padding:0,"z-index":2500},opener:{active:!0,as:"html",open:"",close:"",openerCss:{float:"left",display:"inline-block","background-position":"center center","background-repeat":"no-repeat"},openerClass:""},listSelector:"ul",listsClass:"",listsCss:{},insertZone:50,insertZonePlus:!1,scroll:20,ignoreClass:"clickable",isAllowed:function(e,t,s){return!0},onDragStart:function(e,t){return!0},onChange:function(e){return!0},complete:function(e){return MenuEditor.updateButtons(s),!0}},i=e.extend(!0,{},n,t),o=e("<"+i.listSelector+" />").prependTo(l).attr("id","sortableListsBase").css(i.baseCss).addClass(i.listsClass+" "+i.baseClass),r=e("<li />").attr("id","sortableListsPlaceholder").css(i.placeholderCss).addClass(i.placeholderClass),a=e("<li />").attr("id","sortableListsHint").css(i.hintCss).addClass(i.hintClass),c=e("<"+i.listSelector+" />").attr("id","sortableListsHintWrapper").addClass(i.listsClass+" "+i.hintWrapperClass).css(i.listsCss).css(i.hintWrapperCss),d=e("<span />").addClass("sortableListsOpener "+i.opener.openerClass).css(i.opener.openerCss).on("mousedown",function(t){var s=e(this).closest("li");return s.hasClass("sortableListsClosed")?s.iconOpen(i):s.iconClose(i),!1});"class"===i.opener.as?d.addClass(i.opener.close):"html"===i.opener.as&&d.html(i.opener.close);var p={isDragged:!1,isRelEFP:null,oEl:null,rootEl:null,cEl:null,upScroll:!1,downScroll:!1,pX:0,pY:0,cX:0,cY:0,isAllowed:!0,e:{pageX:0,pageY:0,clientX:0,clientY:0},doc:e(document),win:e(window)};if(i.opener.active){if(!i.opener.open)throw"Opener.open value is not defined. It should be valid url, html or css class.";if(!i.opener.close)throw"Opener.close value is not defined. It should be valid url, html or css class.";e(this).find("li").each(function(){var t=e(this);t.children(i.listSelector).length&&(d.clone(!0).prependTo(t.children("div").first()),t.hasClass("sortableListsOpen")?t.iconOpen(i):t.iconClose(i))})}return this.on("mousedown",function(t){var s=e(t.target);if(!(!1!==p.isDragged||i.ignoreClass&&s.hasClass(i.ignoreClass))){t.preventDefault();var l=s.closest("li"),n=e(this);l[0]&&(i.onDragStart(t,l),function(t,s,l){p.isDragged=!0;var n=parseInt(s.css("margin-top")),c=parseInt(s.css("margin-bottom")),d=parseInt(s.css("margin-left")),h=parseInt(s.css("margin-right")),v=s.offset(),b=s.innerHeight();p.rootEl={el:l,offset:l.offset(),rootElClass:l.attr("class")},p.cEl={el:s,mT:n,mL:d,mB:c,mR:h,offset:v},p.cEl.xyOffsetDiff={X:t.pageX-p.cEl.offset.left,Y:t.pageY-p.cEl.offset.top},p.cEl.el.addClass("sortableListsCurrent "+i.currElClass),s.before(r);var g=p.placeholderNode=e("#sortableListsPlaceholder");s.css({width:s.width(),position:"absolute",top:v.top-e(window).scrollTop()-n,left:v.left-e(window).scrollLeft()-d}).prependTo(o),g.css({display:"block",height:b}),a.css("height",b),p.doc.on("mousemove",u).on("mouseup",f)}(t,l,n))}});function u(t){if(p.isDragged){var s=p.cEl,l=p.doc,n=p.win;t.pageX||function(e){e.pageY=p.pY,e.pageX=p.pX,e.clientY=p.cY,e.clientX=p.cX}(t),l.scrollTop()>p.rootEl.offset.top-10&&t.clientY<50?p.upScroll?(t.pageY=t.pageY-i.scroll,e("html, body").each(function(t){e(this).scrollTop(e(this).scrollTop()-i.scroll)}),h(t)):function(e){if(p.upScroll)return;p.upScroll=setInterval(function(){p.doc.trigger("mousemove")},50)}():l.scrollTop()+n.height()<p.rootEl.offset.top+p.rootEl.el.outerHeight(!1)+10&&n.height()-t.clientY<50?p.downScroll?(t.pageY=t.pageY+i.scroll,e("html, body").each(function(t){e(this).scrollTop(e(this).scrollTop()+i.scroll)}),h(t)):function(e){if(p.downScroll)return;p.downScroll=setInterval(function(){p.doc.trigger("mousemove")},50)}():v(p),p.oElOld=p.oEl,s.el[0].style.visibility="hidden",p.oEl=oEl=function(t,s){if(!document.elementFromPoint)return null;var l=p.isRelEFP;if(null===l){var n,i;(n=p.doc.scrollTop())>0&&(l=null==(i=document.elementFromPoint(0,n+e(window).height()-1))||"HTML"===i.tagName.toUpperCase()),(n=p.doc.scrollLeft())>0&&(l=null==(i=document.elementFromPoint(n+e(window).width()-1,0))||"HTML"===i.tagName.toUpperCase())}l&&(t-=p.doc.scrollLeft(),s-=p.doc.scrollTop());var o=e(document.elementFromPoint(t,s));if(!p.rootEl.el.find(o).length)return null;if(o.is("#sortableListsPlaceholder")||o.is("#sortableListsHint"))return null;if(!o.is("li"))return(o=o.closest("li"))[0]?o:null;if(o.is("li"))return o}(t.pageX,t.pageY),s.el[0].style.visibility="visible",function(e,t){var s=t.oEl;if(!s||!t.oElOld)return;var l=s.outerHeight(!1),n=e.pageY-s.offset().top;i.insertZonePlus?14>n?g(e,s,7>n):l-14<n&&C(e,s,l-7<n):5>n?b(e,s):l-5<n&&m(e,s)}(t,p),function(e,t){var s=t.cEl;s.el.css({position:"fixed",top:e.clientY-s.xyOffsetDiff.Y-s.mT,left:e.clientX-s.xyOffsetDiff.X-s.mL})}(t,p)}}function f(t){var s=p.cEl,l=e("#sortableListsHint",p.rootEl.el),n=a[0].style,o=null,r=!1,c=e("#sortableListsHintWrapper");"block"===n.display&&l.length&&p.isAllowed?(o=l,r=!0):(o=p.placeholderNode,r=!1),offset=o.offset(),s.el.animate({left:offset.left-e(window).scrollLeft()-p.cEl.mL,top:offset.top-e(window).scrollTop()-p.cEl.mT},250,function(){!function(e){var t=e.el[0].style;e.el.removeClass(i.currElClass+" sortableListsCurrent"),t.top="0",t.left="0",t.position="relative",t.width="auto"}(s),o.after(s.el[0]),o[0].style.display="none",n.display="none",l.remove(),c.removeAttr("id").removeClass(i.hintWrapperClass),c.length&&c.prev("div").append(d.clone(!0)),r?p.placeholderNode.slideUp(150,function(){p.placeholderNode.remove(),y(),i.onChange(s.el),i.complete(s.el),p.isDragged=!1}):(p.placeholderNode.remove(),y(),i.complete(s.el),p.isDragged=!1)}),v(p),p.doc.unbind("mousemove",u).unbind("mouseup",f)}function h(e){p.pY=e.pageY,p.pX=e.pageX,p.cY=e.clientY,p.cX=e.clientX}function v(e){clearInterval(e.upScroll),clearInterval(e.downScroll),e.upScroll=e.downScroll=!1}function b(t,s){if(e("#sortableListsHintWrapper",p.rootEl.el).length&&a.unwrap(),t.pageX-s.offset().left<i.insertZone){if(s.prev("#sortableListsPlaceholder").length)return void a.css("display","none");s.before(a)}else{var l=s.children(),n=s.children(i.listSelector).first();if(n.children().first().is("#sortableListsPlaceholder"))return void a.css("display","none");n.length?n.prepend(a):(l.first().after(a),a.wrap(c)),p.oEl&&s.iconOpen(i)}a.css("display","block"),p.isAllowed=i.isAllowed(p.cEl.el,a,a.parents("li").first())}function g(t,s,l){if(e("#sortableListsHintWrapper",p.rootEl.el).length&&a.unwrap(),!l&&t.pageX-s.offset().left>i.insertZone){var n=s.children(),o=s.children(i.listSelector).first();if(o.children().first().is("#sortableListsPlaceholder"))return void a.css("display","none");o.length?o.prepend(a):(n.first().after(a),a.wrap(c)),p.oEl&&s.iconOpen(i)}else{if(s.prev("#sortableListsPlaceholder").length)return void a.css("display","none");s.before(a)}a.css("display","block"),p.isAllowed=i.isAllowed(p.cEl.el,a,a.parents("li").first())}function m(t,s){if(e("#sortableListsHintWrapper",p.rootEl.el).length&&a.unwrap(),t.pageX-s.offset().left<i.insertZone){if(s.next("#sortableListsPlaceholder").length)return void a.css("display","none");s.after(a)}else{var l=s.children(),n=s.children(i.listSelector).last();if(n.children().last().is("#sortableListsPlaceholder"))return void a.css("display","none");n.length?l.last().append(a):(s.append(a),a.wrap(c)),p.oEl&&s.iconOpen(i)}a.css("display","block"),p.isAllowed=i.isAllowed(p.cEl.el,a,a.parents("li").first())}function C(t,s,l){if(e("#sortableListsHintWrapper",p.rootEl.el).length&&a.unwrap(),!l&&t.pageX-s.offset().left>i.insertZone){var n=s.children(),o=s.children(i.listSelector).last();if(o.children().last().is("#sortableListsPlaceholder"))return void a.css("display","none");o.length?n.last().append(a):(s.append(a),a.wrap(c)),p.oEl&&s.iconOpen(i)}else{if(s.next("#sortableListsPlaceholder").length)return void a.css("display","none");s.after(a)}a.css("display","block"),p.isAllowed=i.isAllowed(p.cEl.el,a,a.parents("li").first())}function y(){e(i.listSelector,p.rootEl.el).each(function(t){e(this).children().length||(e(this).prev("div").children(".sortableListsOpener").first().remove(),e(this).remove())})}},e.fn.iconOpen=function(e){this.removeClass("sortableListsClosed").addClass("sortableListsOpen"),this.children("ul").css("display","block");var t=this.children("div").children(".sortableListsOpener").first();"html"===e.opener.as?t.html(e.opener.close):"class"===e.opener.as&&t.addClass(e.opener.close).removeClass(e.opener.open)},e.fn.iconClose=function(e){this.removeClass("sortableListsOpen").addClass("sortableListsClosed"),this.children("ul").css("display","none");var t=this.children("div").children(".sortableListsOpener").first();"html"===e.opener.as?t.html(e.opener.open):"class"===e.opener.as&&t.addClass(e.opener.open).removeClass(e.opener.close)},e.fn.sortableListsToJson=function(){var t=[];return e(this).children("li").each(function(){var s=e(this),l=s.data();t.push(l);var n=s.children("ul,ol").sortableListsToJson();n.length>0?l.children=n:delete l.children}),t},e.fn.updateButtons=function(t){var s=void 0===t?0:t,l=["Up","In"],n=["Down"];0===s&&(l.push("Out"),n.push("Out"),e(this).children("li").hideButtons(["Out"])),e(this).children("li").each(function(){var t=e(this).children("ul");t.length>0&&t.updateButtons(s+1)}),e(this).children("li:first").hideButtons(l),e(this).children("li:last").hideButtons(n)},e.fn.hideButtons=function(t){for(var s=0;s<t.length;s++)e(this).find(".btn-group:first").children(".btn"+t[s]).hide()}}(jQuery),MenuEditor.updateButtons=function(e){e.find(".btnMove").show(),e.updateButtons()};